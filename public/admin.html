<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/css/base.css" />
  </head>
  <body>
    <div class="container">
      <div id="nav"></div>

      <div class="card" style="margin-top: 14px">
        <div class="card-body">
          <h1 class="page-title">Admin Dashboard</h1>
          <p class="muted">Review and remove suspicious posts.</p>
          <div id="msg" class="alert" style="display: none"></div>

          <h2 style="font-size: 16px; font-weight: 700; margin: 16px 0 8px">Lost Items</h2>
          <div id="lostList"></div>

          <h2 style="font-size: 16px; font-weight: 700; margin: 16px 0 8px">Found Items</h2>
          <div id="foundList"></div>
        </div>
      </div>
    </div>

    <script type="module">
      const msg = document.getElementById("msg");
      const lostList = document.getElementById("lostList");
      const foundList = document.getElementById("foundList");

      function showMsg(text, ok) {
        msg.style.display = "block";
        msg.textContent = text;
        msg.className = ok ? "alert alert-ok" : "alert alert-err";
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function renderItems(items, container, type) {
        if (!items || !items.length) {
          container.innerHTML = `<div class="muted">No ${type} items.</div>`;
          return;
        }

        container.innerHTML = items.map(it => {
          const status = type === "lost"
            ? (it.resolved ? "RESOLVED" : "OPEN")
            : (it.claimed ? "CLAIMED" : "UNCLAIMED");

          return `
            <div class="card" style="margin-bottom: 12px;" data-id="${it._id}" data-type="${type}">
              <div class="card-body">
                <div class="row">
                  <div>
                    <div style="font-weight: 700; font-size: 16px;">
                      ${escapeHtml(it.title)}
                      <span class="muted">(${status})</span>
                    </div>
                    <div class="muted" style="margin-top: 4px;">
                      ${escapeHtml(it.category)} • ${escapeHtml(it.location)} • ${escapeHtml(it.date)}
                    </div>
                    <div style="margin-top: 6px;">
                      <b>Description:</b> ${escapeHtml(it.description)}
                    </div>
                  </div>
                  <div class="spacer"></div>
                  <button class="btn btn-danger deleteBtn" type="button">Delete</button>
                </div>
              </div>
            </div>`;
        }).join("");

        container.querySelectorAll(".deleteBtn").forEach(btn => {
          btn.addEventListener("click", async (e) => {
            const card = e.target.closest("div[data-id]");
            const id = card.dataset.id;
            const itemType = card.dataset.type;

            const resp = await fetch(`/api/admin/${itemType}-items/${id}`, { method: "DELETE" });
            if (resp.ok) {
              card.remove();
            } else {
              const d = await resp.json();
              showMsg(d.error || "Delete failed", false);
            }
          });
        });
      }

      const resp = await fetch("/api/admin/items");
      const data = await resp.json();

      if (!resp.ok) {
        showMsg(data.error || "Failed to load — admin only", false);
      } else {
        renderItems(data.lost, lostList, "lost");
        renderItems(data.found, foundList, "found");
      }
    </script>

    <script type="module" src="/js/nav.js"></script>
  </body>
</html>
