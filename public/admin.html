<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: 'Inter', sans-serif; background: #f8fafc; display: flex; min-height: 100vh; }

      /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
      .sidebar {
        width: 220px;
        min-height: 100vh;
        background: #fff;
        border-right: 1px solid #e2e8f0;
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0; left: 0;
      }
      .sidebar-brand {
        padding: 20px 20px 16px;
        border-bottom: 1px solid #f1f5f9;
      }
      .sidebar-brand .title { font-size: 15px; font-weight: 700; color: #0f172a; }
      .sidebar-brand .sub   { font-size: 12px; color: #94a3b8; margin-top: 2px; }

      .sidebar-nav { flex: 1; padding: 12px 0; }
      .nav-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 20px;
        font-size: 14px;
        color: #475569;
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: all 0.1s;
        text-decoration: none;
      }
      .nav-item:hover { background: #f8fafc; color: #0f172a; }
      .nav-item.active { background: #eff6ff; color: #1d4ed8; border-left-color: #3b82f6; font-weight: 600; }
      .nav-item svg { width: 16px; height: 16px; flex-shrink: 0; }

      .sidebar-footer {
        padding: 16px 20px;
        border-top: 1px solid #f1f5f9;
      }
      .logout-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: #64748b;
        cursor: pointer;
        background: none;
        border: none;
        font-family: 'Inter', sans-serif;
        padding: 0;
      }
      .logout-btn:hover { color: #dc2626; }

      /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
      .main {
        margin-left: 220px;
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      .topbar {
        background: #fff;
        border-bottom: 1px solid #e2e8f0;
        padding: 14px 28px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 14px;
        color: #64748b;
      }
      .topbar-title { font-size: 15px; font-weight: 600; color: #0f172a; }
      .content { padding: 28px; }

      /* ‚îÄ‚îÄ Views ‚îÄ‚îÄ */
      .view { display: none; }
      .view.active { display: block; }

      .page-heading { font-size: 24px; font-weight: 700; color: #0f172a; margin-bottom: 4px; }
      .page-sub { font-size: 14px; color: #64748b; margin-bottom: 24px; }
      .total-label { font-size: 13px; color: #94a3b8; }

      /* Stats row */
      .stats-row {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 14px;
        margin-bottom: 24px;
      }
      .stat-card {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 16px;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .stat-icon {
        width: 40px; height: 40px;
        border-radius: 10px;
        display: flex; align-items: center; justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
      }
      .stat-label { font-size: 12px; color: #94a3b8; }
      .stat-value { font-size: 22px; font-weight: 700; color: #0f172a; }

      /* Two-col layout for dashboard middle */
      .dash-mid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        margin-bottom: 20px;
      }
      .panel {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
        padding: 20px;
      }
      .panel-title { font-size: 15px; font-weight: 600; color: #0f172a; margin-bottom: 16px; }

      /* Status bars */
      .status-bar-row { margin-bottom: 12px; }
      .status-bar-label {
        display: flex; justify-content: space-between;
        font-size: 13px; color: #475569; margin-bottom: 5px;
      }
      .bar-track { background: #f1f5f9; border-radius: 99px; height: 8px; }
      .bar-fill  { background: #3b82f6; border-radius: 99px; height: 8px; transition: width 0.4s; }

      /* Activity */
      .activity-item {
        display: flex; align-items: flex-start; gap: 12px;
        padding: 8px 0;
        border-bottom: 1px solid #f8fafc;
        font-size: 13px;
      }
      .activity-icon {
        width: 30px; height: 30px;
        background: #eff6ff; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        flex-shrink: 0;
        font-size: 14px;
      }
      .activity-text { color: #374151; line-height: 1.4; }
      .activity-time { color: #94a3b8; font-size: 11px; margin-top: 2px; }

      /* Category grid */
      .cat-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-top: 4px;
      }
      .cat-cell {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
        padding: 14px;
        text-align: center;
      }
      .cat-num  { font-size: 22px; font-weight: 700; color: #3b82f6; }
      .cat-name { font-size: 12px; color: #64748b; margin-top: 2px; }

      /* ‚îÄ‚îÄ Table shared ‚îÄ‚îÄ */
      .table-panel {
        background: #fff;
        border: 1px solid #e2e8f0;
        border-radius: 14px;
        overflow: hidden;
        margin-top: 16px;
      }
      .table-toolbar {
        padding: 14px 20px;
        display: flex; gap: 10px; flex-wrap: wrap;
        border-bottom: 1px solid #f1f5f9;
      }
      .table-toolbar input,
      .table-toolbar select {
        flex: 1; min-width: 140px;
        padding: 8px 12px;
        border: 1px solid #e2e8f0; border-radius: 8px;
        font-size: 13px; font-family: 'Inter', sans-serif;
        background: #f8fafc; color: #0f172a;
      }
      table { width: 100%; border-collapse: collapse; }
      thead th {
        padding: 10px 16px;
        text-align: left;
        font-size: 11px; font-weight: 600;
        letter-spacing: 0.07em; text-transform: uppercase;
        color: #94a3b8; background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }
      tbody tr { border-bottom: 1px solid #f1f5f9; transition: background 0.1s; }
      tbody tr:last-child { border-bottom: none; }
      tbody tr:hover { background: #fafafa; }
      tbody td { padding: 12px 16px; font-size: 13px; color: #334155; vertical-align: middle; }

      .td-title { font-weight: 600; color: #0f172a; font-size: 13px; }
      .td-sub   { font-size: 11px; color: #94a3b8; margin-top: 2px;
        max-width: 240px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

      .badge {
        display: inline-flex; align-items: center; gap: 4px;
        padding: 3px 9px; border-radius: 20px;
        font-size: 11px; font-weight: 600;
      }
      .badge-open     { background: #fef9c3; color: #854d0e; }
      .badge-resolved { background: #dcfce7; color: #166534; }
      .badge-claimed  { background: #dcfce7; color: #166534; }
      .badge-unclaimed{ background: #fef9c3; color: #854d0e; }
      .badge-lost     { background: #fee2e2; color: #991b1b; font-size: 10px; padding: 2px 6px; margin-left: 4px; }

      .icon-btn {
        width: 28px; height: 28px; border-radius: 6px;
        border: none; background: transparent; cursor: pointer;
        display: inline-flex; align-items: center; justify-content: center;
        transition: background 0.1s;
      }
      .icon-btn:hover { background: #f1f5f9; }
      .icon-btn.del:hover { background: #fee2e2; }
      .icon-btn svg { width: 15px; height: 15px; }

      .reporter-avatar {
        width: 32px; height: 32px; border-radius: 50%;
        background: #dbeafe; color: #1d4ed8;
        display: flex; align-items: center; justify-content: center;
        font-size: 14px; flex-shrink: 0;
      }

      .alert { padding: 10px 14px; border-radius: 8px; font-size: 13px; margin-bottom: 14px; display: none; }
      .alert-ok  { background: #dcfce7; color: #166534; }
      .alert-err { background: #fee2e2; color: #991b1b; }

      .empty-state { text-align: center; padding: 40px; color: #94a3b8; font-size: 14px; }

      @media (max-width: 700px) {
        .sidebar { width: 100%; min-height: auto; position: relative; flex-direction: row; flex-wrap: wrap; }
        .main { margin-left: 0; }
        .dash-mid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-brand">
        <div class="title">Admin Portal</div>
        <div class="sub">Lost &amp; Found Management</div>
      </div>
      <nav class="sidebar-nav">
        <a class="nav-item active" data-view="dashboard" href="#">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/></svg>
          Dashboard
        </a>
        <a class="nav-item" data-view="items" href="#">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
          Manage Items
        </a>
        <a class="nav-item" data-view="reporters" href="#">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Reporters
        </a>
      </nav>
      <div class="sidebar-footer">
        <button class="logout-btn" id="logoutBtn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
          Logout
        </button>
      </div>
    </aside>

    <!-- Main -->
    <div class="main">
      <div class="topbar">
        <span class="topbar-title" id="topbarTitle">Dashboard</span>
        <span id="topbarWelcome">Welcome, Admin</span>
      </div>

      <div class="content">
        <div id="msgGlobal" class="alert"></div>

        <!-- ‚îÄ‚îÄ DASHBOARD VIEW ‚îÄ‚îÄ -->
        <div class="view active" id="view-dashboard">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:20px;">
            <div>
              <div class="page-heading">Admin Dashboard</div>
              <div class="page-sub" style="margin-bottom:0;">Overview of all lost &amp; found activity.</div>
            </div>
          </div>

          <div class="stats-row" id="statsRow">
            <div class="stat-card"><div class="stat-icon" style="background:#dbeafe;">üì¶</div><div><div class="stat-label">Total Items</div><div class="stat-value" id="statTotal">‚Äî</div></div></div>
            <div class="stat-card"><div class="stat-icon" style="background:#fee2e2;">‚ö†Ô∏è</div><div><div class="stat-label">Lost Items</div><div class="stat-value" id="statLost">‚Äî</div></div></div>
            <div class="stat-card"><div class="stat-icon" style="background:#dcfce7;">‚úÖ</div><div><div class="stat-label">Found Items</div><div class="stat-value" id="statFound">‚Äî</div></div></div>
            <div class="stat-card"><div class="stat-icon" style="background:#fef9c3;">üïê</div><div><div class="stat-label">Pending Claims</div><div class="stat-value" id="statPending">‚Äî</div></div></div>
          </div>

          <div class="dash-mid">
            <div class="panel">
              <div class="panel-title">Items by Status</div>
              <div id="statusBars"></div>
            </div>
            <div class="panel">
              <div class="panel-title">Recent Activity</div>
              <div id="recentActivity"></div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-title">Items by Category</div>
            <div class="cat-grid" id="catGrid"></div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ MANAGE ITEMS VIEW ‚îÄ‚îÄ -->
        <div class="view" id="view-items">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <div class="page-heading">Manage Items</div>
            <span class="total-label" id="itemsTotal"></span>
          </div>
          <div class="page-sub">View and delete all reported lost &amp; found items.</div>

          <div class="table-panel">
            <div class="table-toolbar">
              <input type="text" id="itemSearch" placeholder="üîç  Search items..." />
              <select id="itemFilterCat">
                <option value="">All Categories</option>
                <option>Electronics</option><option>ID / Card</option><option>Keys</option>
                <option>Wallet</option><option>Clothing</option><option>Books / Notes</option>
                <option>Accessories / Jewelry</option><option>Bag / Backpack</option>
                <option>Water Bottle</option><option>Other</option>
              </select>
              <select id="itemFilterType">
                <option value="">Lost &amp; Found</option>
                <option value="lost">Lost only</option>
                <option value="found">Found only</option>
              </select>
            </div>
            <div id="itemsTableWrap"></div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ REPORTERS VIEW ‚îÄ‚îÄ -->
        <div class="view" id="view-reporters">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px;">
            <div class="page-heading">Manage Reporters</div>
            <span class="total-label" id="reportersTotal"></span>
          </div>
          <div class="page-sub">View students who have posted items.</div>

          <div class="table-panel">
            <div class="table-toolbar">
              <input type="text" id="reporterSearch" placeholder="üîç  Search reporters..." />
            </div>
            <div id="reportersTableWrap"></div>
          </div>
        </div>

      </div><!-- /content -->
    </div><!-- /main -->

    <script type="module">
      // ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let allLost  = [];
      let allFound = [];
      let allClaims = [];

      // ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const msgEl = document.getElementById("msgGlobal");
      function showMsg(text, ok) {
        msgEl.style.display = "block";
        msgEl.textContent = text;
        msgEl.className = ok ? "alert alert-ok" : "alert alert-err";
        setTimeout(() => { msgEl.style.display = "none"; }, 3000);
      }
      function esc(s) {
        return String(s ?? "")
          .replaceAll("&","&amp;").replaceAll("<","&lt;")
          .replaceAll(">","&gt;").replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }
      function fmtDate(d) {
        if (!d) return "‚Äî";
        return new Date(d).toLocaleDateString("en-US", { month:"short", day:"numeric", year:"numeric" });
      }

      // ‚îÄ‚îÄ Nav ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const navItems = document.querySelectorAll(".nav-item[data-view]");
      const views    = document.querySelectorAll(".view");
      const topbarTitle = document.getElementById("topbarTitle");
      const titles = { dashboard: "Dashboard", items: "Manage Items", reporters: "Reporters" };

      navItems.forEach(item => {
        item.addEventListener("click", e => {
          e.preventDefault();
          navItems.forEach(n => n.classList.remove("active"));
          views.forEach(v => v.classList.remove("active"));
          item.classList.add("active");
          document.getElementById("view-" + item.dataset.view).classList.add("active");
          topbarTitle.textContent = titles[item.dataset.view];
        });
      });

      // ‚îÄ‚îÄ Logout ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await fetch("/api/auth/logout", { method: "POST" });
        window.location.href = "/login.html";
      });

      // ‚îÄ‚îÄ Load data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function loadAll() {
        // Check admin
        const meResp = await fetch("/api/auth/me");
        const me = await meResp.json();
        if (!me.loggedIn || me.role !== "admin") {
          document.body.innerHTML = `<div style="padding:40px;font-family:Inter,sans-serif;color:#991b1b;">Access denied ‚Äî admin only. <a href="/login.html">Login</a></div>`;
          return;
        }
        document.getElementById("topbarWelcome").textContent = `Welcome, ${esc(me.username)}`;

        // Items
        const itemsResp = await fetch("/api/admin/items");
        const itemsData = await itemsResp.json();
        if (!itemsResp.ok) { showMsg(itemsData.error || "Failed to load", false); return; }
        allLost  = itemsData.lost  || [];
        allFound = itemsData.found || [];

        // Claims
        try {
          const clResp = await fetch("/api/claims/received");
          const clData = await clResp.json();
          if (clResp.ok) allClaims = clData.claims || [];
        } catch { /* not critical */ }

        renderDashboard();
        renderItemsTable();
        renderReporters();
      }

      // ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderDashboard() {
        const total   = allLost.length + allFound.length;
        const pending = allClaims.filter(c => c.status === "pending").length;
        const claimed = allFound.filter(f => f.claimed).length;
        const open    = allLost.filter(l => !l.resolved).length;

        document.getElementById("statTotal").textContent   = total;
        document.getElementById("statLost").textContent    = allLost.length;
        document.getElementById("statFound").textContent   = allFound.length;
        document.getElementById("statPending").textContent = pending;

        // Status bars
        const bars = [
          { label: "Open Lost", count: open,    max: total },
          { label: "Claimed",   count: claimed, max: total },
          { label: "Pending Claims", count: pending, max: Math.max(pending, 1) },
        ];
        document.getElementById("statusBars").innerHTML = bars.map(b => `
          <div class="status-bar-row">
            <div class="status-bar-label"><span>${b.label}</span><span>${b.count}</span></div>
            <div class="bar-track"><div class="bar-fill" style="width:${b.max ? Math.round(b.count/b.max*100) : 0}%"></div></div>
          </div>`).join("");

        // Recent activity ‚Äî last 4 items by createdAt
        const recent = [...allLost, ...allFound]
          .filter(x => x.createdAt)
          .sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt))
          .slice(0, 4);
        document.getElementById("recentActivity").innerHTML = recent.length
          ? recent.map(it => `
            <div class="activity-item">
              <div class="activity-icon">${it.ownerUserId ? "üìã" : "üîç"}</div>
              <div>
                <div class="activity-text">${esc(it.title)}</div>
                <div class="activity-time">${fmtDate(it.createdAt)}</div>
              </div>
            </div>`).join("")
          : `<div class="empty-state">No recent activity</div>`;

        // Category grid
        const cats = {};
        [...allLost, ...allFound].forEach(it => {
          cats[it.category] = (cats[it.category] || 0) + 1;
        });
        const catEntries = Object.entries(cats).sort((a,b) => b[1]-a[1]);
        document.getElementById("catGrid").innerHTML = catEntries.length
          ? catEntries.map(([cat, n]) => `
            <div class="cat-cell">
              <div class="cat-num">${n}</div>
              <div class="cat-name">${esc(cat)}</div>
            </div>`).join("")
          : `<div style="grid-column:1/-1;" class="empty-state">No data yet</div>`;
      }

      // ‚îÄ‚îÄ Manage Items table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderItemsTable() {
        const search = (document.getElementById("itemSearch").value || "").toLowerCase();
        const cat    = document.getElementById("itemFilterCat").value;
        const type   = document.getElementById("itemFilterType").value;

        let rows = [];
        if (!type || type === "lost")  rows.push(...allLost.map(i  => ({...i, _type:"lost"})));
        if (!type || type === "found") rows.push(...allFound.map(i => ({...i, _type:"found"})));

        rows = rows.filter(it =>
          (!cat || it.category === cat) &&
          (!search || it.title.toLowerCase().includes(search) || it.description?.toLowerCase().includes(search))
        );

        document.getElementById("itemsTotal").textContent = `Total Items: ${rows.length}`;

        if (!rows.length) {
          document.getElementById("itemsTableWrap").innerHTML = `<div class="empty-state">No items match.</div>`;
          return;
        }

        document.getElementById("itemsTableWrap").innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Item Details</th>
                <th>Category</th>
                <th>Location</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              ${rows.map(it => {
                const badgeClass = it._type === "lost"
                  ? (it.resolved ? "badge-resolved" : "badge-open")
                  : (it.claimed  ? "badge-claimed"  : "badge-unclaimed");
                const badgeText = it._type === "lost"
                  ? (it.resolved ? "Resolved" : "Open")
                  : (it.claimed  ? "Claimed"  : "Unclaimed");
                const imgThumb = it.image
                  ? `<img src="${esc(it.image)}" style="width:36px;height:36px;object-fit:cover;border-radius:6px;margin-right:10px;vertical-align:middle;" onerror="this.style.display='none'" />`
                  : "";
                return `
                  <tr data-id="${it._id}" data-type="${it._type}">
                    <td>
                      <div style="display:flex;align-items:center;">
                        ${imgThumb}
                        <div>
                          <div class="td-title">
                            ${esc(it.title)}
                            ${it._type === "lost" ? `<span class="badge badge-lost">Lost</span>` : ""}
                          </div>
                          <div class="td-sub">${esc(it.description)}</div>
                        </div>
                      </div>
                    </td>
                    <td>${esc(it.category)}</td>
                    <td>${esc(it.location)}</td>
                    <td style="white-space:nowrap;">${esc(it.date)}</td>
                    <td><span class="badge ${badgeClass}">${badgeText}</span></td>
                    <td>
                      <button class="icon-btn del deleteBtn" title="Delete" aria-label="Delete item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
                      </button>
                    </td>
                  </tr>`;
              }).join("")}
            </tbody>
          </table>`;

        document.querySelectorAll(".deleteBtn").forEach(btn => {
          btn.addEventListener("click", async e => {
            const tr   = e.target.closest("tr[data-id]");
            const id   = tr.dataset.id;
            const itype = tr.dataset.type;
            const resp = await fetch(`/api/admin/${itype}-items/${id}`, { method: "DELETE" });
            if (resp.ok) {
              if (itype === "lost")  allLost  = allLost.filter(x => String(x._id) !== id);
              else                   allFound = allFound.filter(x => String(x._id) !== id);
              renderDashboard();
              renderItemsTable();
              renderReporters();
              showMsg("Item deleted.", true);
            } else {
              const d = await resp.json().catch(() => ({}));
              showMsg(d.error || "Delete failed", false);
            }
          });
        });
      }

      // ‚îÄ‚îÄ Reporters table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderReporters() {
        const search = (document.getElementById("reporterSearch").value || "").toLowerCase();
        const all = [...allLost, ...allFound];

        // Group by ownerUserId
        const map = {};
        all.forEach(it => {
          const uid = it.ownerUserId || "unknown";
          if (!map[uid]) map[uid] = { userId: uid, items: [] };
          map[uid].items.push(it);
        });

        let reporters = Object.values(map).filter(r =>
          !search || r.userId.toLowerCase().includes(search)
        );

        document.getElementById("reportersTotal").textContent = `Total Reporters: ${reporters.length}`;

        if (!reporters.length) {
          document.getElementById("reportersTableWrap").innerHTML = `<div class="empty-state">No reporters found.</div>`;
          return;
        }

        document.getElementById("reportersTableWrap").innerHTML = `
          <table>
            <thead>
              <tr>
                <th>Reporter</th>
                <th>Items Reported</th>
                <th>Last Reported</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${reporters.map(r => {
                const sorted = r.items.sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
                const lastDate = sorted[0]?.createdAt ? fmtDate(sorted[0].createdAt) : "‚Äî";
                const initials = r.userId.slice(0,2).toUpperCase();
                return `
                  <tr>
                    <td>
                      <div style="display:flex;align-items:center;gap:10px;">
                        <div class="reporter-avatar">${initials}</div>
                        <div>
                          <div class="td-title">User</div>
                          <div class="td-sub">ID: ${esc(r.userId)}</div>
                        </div>
                      </div>
                    </td>
                    <td>${r.items.length}</td>
                    <td>${lastDate}</td>
                    <td><span class="badge badge-resolved">Active</span></td>
                  </tr>`;
              }).join("")}
            </tbody>
          </table>`;
      }

      // Filter listeners
      document.getElementById("itemSearch").addEventListener("input", renderItemsTable);
      document.getElementById("itemFilterCat").addEventListener("change", renderItemsTable);
      document.getElementById("itemFilterType").addEventListener("change", renderItemsTable);
      document.getElementById("reporterSearch").addEventListener("input", renderReporters);

      loadAll();
    </script>
  </body>
</html>
